<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>TouchFret</title>
    <style>
      :root {
        font-family: "Avenir Next", "Futura", "Trebuchet MS", sans-serif;
        color: #f4f4f4;
        --bg-color: #000000;
        --bg-anim-a: #101a2a;
        --bg-anim-b: #1a3f5a;
        --bg-anim-c: #24112f;
        --panel: rgba(10, 10, 10, 0.78);
        --panel-strong: rgba(15, 15, 15, 0.92);
        --text-muted: #9a9a9a;
        --pad-gap: clamp(6px, 1.2vw, 14px);
        --row-gap: -8px;
        --row-scale: 1;
        --pad-radius: 16px;
        --pad-fill: #0a0a0a;
        --pad-border: rgba(255, 255, 255, 0.8);
        --pad-glow: rgba(255, 255, 255, 0.25);
        --pad-active-fill: #1a1a1a;
        --pad-active-glow: rgba(255, 255, 255, 0.7);
        --pad-scale: 1.06;
        --pad-text-size: 64px;
        --marker-color: rgba(255, 255, 255, 0.7);
        --marker-offset: -6px;
        --marker-width: 6px;
        --marker-height: 6px;
        --marker-radius: 999px;
        --marker-rotate: 0deg;
        --bg-media-opacity: 0.55;
        --bg-media-blur: 0px;
        --pad-image: none;
        --pad-image-active: none;
      }

      * {
        box-sizing: border-box;
      }

      html {
        height: 100%;
        width: 100%;
      }

      body {
        margin: 0;
        min-height: 100vh;
        height: 100vh;
        height: 100svh;
        width: 100vw;
        background: var(--bg-color);
        color: inherit;
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
      }

      input,
      select,
      textarea {
        user-select: text;
        -webkit-user-select: text;
      }

      .background-layer {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
      }

      .background-layer img,
      .background-layer video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        filter: blur(var(--bg-media-blur));
        transition: opacity 0.2s ease;
      }

      body[data-bg-mode="image"] .background-layer img {
        opacity: var(--bg-media-opacity);
      }

      body[data-bg-mode="video"] .background-layer video {
        opacity: var(--bg-media-opacity);
      }

      main.app {
        position: relative;
        z-index: 1;
        min-height: 100vh;
        height: 100%;
        width: 100%;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 12px;
        padding: calc(clamp(12px, 2.5vw, 24px) + env(safe-area-inset-top))
          calc(clamp(12px, 2.5vw, 24px) + env(safe-area-inset-right))
          calc(clamp(12px, 2.5vw, 24px) + env(safe-area-inset-bottom))
          calc(clamp(12px, 2.5vw, 24px) + env(safe-area-inset-left));
      }

      header.toolbar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 12px;
        width: 100%;
        margin: 0;
      }

      .toolbar-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .toolbar-group.left {
        justify-self: start;
      }

      .toolbar-group.right {
        justify-self: end;
      }

      .toolbar-center {
        justify-self: center;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .fretboard-area {
        display: grid;
        grid-template-rows: auto minmax(0, 1fr) auto auto;
        gap: 2px;
        width: 100%;
        margin: 0;
        min-height: 0;
      }

      .pill {
        padding: 8px 12px;
        border-radius: 999px;
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 0.85rem;
        letter-spacing: 0.02em;
      }

      .no-select,
      button,
      .pill,
      .pad,
      .fretboard,
      .fretboard-area,
      .fret-markers,
      header.toolbar {
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
      }

      button {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 10px 14px;
        background: var(--panel);
        color: inherit;
        font-size: 0.85rem;
        letter-spacing: 0.02em;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      }

      button:hover {
        border-color: rgba(255, 255, 255, 0.4);
      }

      button:active {
        transform: translateY(1px);
      }

      button[aria-pressed="true"] {
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
        background: var(--panel-strong);
      }

      .fret-markers {
        display: grid;
        grid-template-columns: repeat(13, minmax(0, 1fr));
        gap: var(--pad-gap);
        height: 6px;
        align-items: center;
        justify-items: center;
        width: 100%;
        margin: var(--marker-offset) 0;
      }

      .fret-markers .marker-dot {
        width: var(--marker-width);
        height: var(--marker-height);
        border-radius: var(--marker-radius);
        transform: rotate(var(--marker-rotate));
        background: var(--marker-color);
        opacity: 0;
        box-shadow: 0 0 10px var(--marker-color);
      }

      .fret-markers .marker-dot.marker {
        opacity: 1;
      }

      body[data-marker-shape="dot"] {
        --marker-width: 6px;
        --marker-height: 6px;
        --marker-radius: 999px;
        --marker-rotate: 0deg;
      }

      body[data-marker-shape="square"] {
        --marker-width: 6px;
        --marker-height: 6px;
        --marker-radius: 2px;
        --marker-rotate: 0deg;
      }

      body[data-marker-shape="diamond"] {
        --marker-width: 8px;
        --marker-height: 8px;
        --marker-radius: 2px;
        --marker-rotate: 45deg;
      }

      body[data-marker-shape="bar"] {
        --marker-width: 16px;
        --marker-height: 4px;
        --marker-radius: 999px;
        --marker-rotate: 0deg;
      }

      body[data-marker-mode="pads"] .fret-markers,
      body[data-marker-mode="off"] .fret-markers {
        opacity: 0;
        height: 0;
      }

      .fretboard {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0;
        touch-action: none;
        user-select: none;
        width: 100%;
        min-height: 0;
      }

      .string-row {
        display: grid;
        grid-template-columns: repeat(13, minmax(0, 1fr));
        gap: var(--pad-gap);
        margin-top: var(--row-gap);
        transform: scaleY(var(--row-scale));
        transform-origin: top center;
      }

      .string-row:first-child {
        margin-top: 0;
      }

      .drumkit {
        display: none;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        grid-template-rows: repeat(4, minmax(0, 1fr));
        gap: var(--pad-gap);
        width: 100%;
        min-height: 0;
        touch-action: none;
      }

      body[data-layout="drum"] .drumkit {
        display: grid;
      }

      body[data-layout="drum"] #fretboard,
      body[data-layout="drum"] .fret-markers,
      body[data-layout="drum"] #sustain-toggle {
        display: none;
      }

      .pad,
      .drum-pad {
        position: relative;
        aspect-ratio: 1 / 1;
        border-radius: var(--pad-radius);
        border: 2px solid var(--row-border, var(--pad-border));
        background: var(--pad-fill);
        box-shadow: 0 0 0 1px var(--row-border, var(--pad-border)),
          0 0 16px var(--row-glow, var(--pad-glow));
        display: grid;
        place-items: center;
        transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
      }

      .pad .pad-emoji,
      .drum-pad .pad-emoji {
        position: absolute;
        pointer-events: none;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--pad-text-size);
        line-height: 1;
        text-align: center;
      }

      .pad::after,
      .drum-pad::after {
        content: "";
        position: absolute;
        width: var(--marker-width);
        height: var(--marker-height);
        border-radius: var(--marker-radius);
        transform: rotate(var(--marker-rotate));
        background: var(--marker-color);
        box-shadow: 0 0 10px var(--marker-color);
        opacity: 0;
      }

      .pad.marker::after,
      .drum-pad.marker::after {
        opacity: 0;
      }

      body[data-marker-mode="pads"] .pad.marker::after,
      body[data-marker-mode="pads"] .drum-pad.marker::after,
      body[data-marker-mode="both"] .pad.marker::after,
      body[data-marker-mode="both"] .drum-pad.marker::after {
        opacity: 0.8;
      }

      .pad.active,
      .drum-pad.active {
        background: var(--pad-active-fill);
        box-shadow: 0 0 0 2px var(--row-glow, var(--pad-active-glow)),
          0 0 20px var(--row-glow, var(--pad-active-glow));
      }

      .drum-pad {
        aspect-ratio: auto;
        width: 100%;
        height: 100%;
      }

      .drumkit[data-drum-shape="round"] .drum-pad {
        border-radius: 50%;
      }

      .drumkit[data-drum-shape="kit"] .drum-pad.cymbal {
        border-radius: 999px;
        height: 70%;
        align-self: center;
      }

      .drumkit[data-drum-shape="kit"] .drum-pad.rim {
        border-style: dashed;
        background: transparent;
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
        transform: scale(0.7);
        align-self: center;
        justify-self: center;
      }

      body[data-scale="on"] .pad.active,
      body[data-scale="on"] .drum-pad.active {
        transform: scale(var(--pad-scale));
      }

      body[data-scale="off"] .pad.active,
      body[data-scale="off"] .drum-pad.active {
        transform: none;
      }

      @keyframes padPulse {
        0%,
        100% {
          box-shadow: 0 0 0 2px var(--row-glow, var(--pad-active-glow)),
            0 0 18px var(--row-glow, var(--pad-active-glow));
        }
        50% {
          box-shadow: 0 0 0 3px var(--row-glow, var(--pad-active-glow)),
            0 0 28px var(--row-glow, var(--pad-active-glow));
        }
      }

      body[data-glow="on"][data-pulse="on"] .pad.active,
      body[data-glow="on"][data-pulse="on"] .drum-pad.active {
        animation: padPulse 1.2s ease-in-out infinite;
      }

      body[data-glow="off"] .pad.active,
      body[data-glow="off"] .drum-pad.active,
      body[data-pulse="off"] .pad.active,
      body[data-pulse="off"] .drum-pad.active {
        animation: none;
      }

      body[data-glow="off"] .pad,
      body[data-glow="off"] .drum-pad {
        box-shadow: none;
      }

      body[data-glow="off"] .pad.active,
      body[data-glow="off"] .drum-pad.active {
        box-shadow: none;
      }

      @keyframes bgShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes hueSpin {
        from {
          filter: hue-rotate(0deg);
        }
        to {
          filter: hue-rotate(360deg);
        }
      }

      body[data-bg-animated="on"] {
        background: linear-gradient(120deg, var(--bg-anim-a), var(--bg-anim-b), var(--bg-anim-c));
        background-size: 220% 220%;
        animation: bgShift 14s ease infinite;
      }

      body[data-hue-shift="on"] .fretboard {
        animation: hueSpin 10s linear infinite;
      }

      .fretboard[data-shape="square"] .pad {
        border-radius: 6px;
      }

      .fretboard[data-shape="rounded"] .pad {
        border-radius: var(--pad-radius);
      }

      .fretboard[data-shape="circle"] .pad {
        border-radius: 50%;
      }

      .fretboard[data-shape="hex"] .pad {
        border-radius: 8px;
        clip-path: polygon(25% 4%, 75% 4%, 98% 50%, 75% 96%, 25% 96%, 2% 50%);
      }

      .fretboard[data-shape="diamond"] .pad {
        border-radius: 6px;
        clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
      }

      .fretboard[data-shape="octagon"] .pad {
        border-radius: 6px;
        clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
      }

      .fretboard[data-content-mode="blank"] .pad-emoji,
      .drumkit[data-content-mode="blank"] .pad-emoji {
        display: none;
      }

      .fretboard[data-content-mode="image"] .pad,
      .drumkit[data-content-mode="image"] .drum-pad {
        background-image: var(--pad-image);
        background-size: cover;
        background-position: center;
      }

      .fretboard[data-content-mode="image"] .pad.active,
      .drumkit[data-content-mode="image"] .drum-pad.active {
        background-image: var(--pad-image-active, var(--pad-image));
      }

      .fretboard[data-content-mode="image"] .pad-emoji,
      .drumkit[data-content-mode="image"] .pad-emoji {
        display: none;
      }

      .fretboard[data-content-mode="emoji"] .pad,
      .drumkit[data-content-mode="emoji"] .drum-pad {
        background: transparent;
        border-color: transparent;
        box-shadow: none;
      }

      .fretboard[data-content-mode="emoji"] .pad .pad-emoji,
      .drumkit[data-content-mode="emoji"] .drum-pad .pad-emoji {
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.35));
      }

      .fretboard[data-content-mode="emoji"] .pad.active .pad-emoji,
      .drumkit[data-content-mode="emoji"] .drum-pad.active .pad-emoji {
        filter: drop-shadow(0 0 14px rgba(255, 255, 255, 0.7));
      }

      .control-button {
        border-width: 2px;
        border-color: rgba(255, 255, 255, 0.55);
        background: rgba(8, 8, 8, 0.6);
        box-shadow: 0 0 14px rgba(255, 255, 255, 0.12);
      }

      body[data-control-fill="outline"] .control-button {
        background: transparent;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      }

      body[data-pad-fill="outline"] .pad,
      body[data-pad-fill="outline"] .drum-pad,
      body[data-pad-fill="outline"] .pad.active,
      body[data-pad-fill="outline"] .drum-pad.active {
        background: transparent;
      }

      .sustain-bar {
        width: 100%;
        min-height: 52px;
        border-radius: 14px;
        padding: 12px 16px;
        font-size: 0.9rem;
        letter-spacing: 0;
      }

      #vibrato-toggle {
        min-width: 220px;
        min-height: 56px;
        padding: 14px 24px;
      }

      .octave-button {
        min-width: 70px;
        min-height: 48px;
        padding: 12px 20px;
        border-radius: 14px;
        font-size: 1.3rem;
      }


      .icon-button {
        width: 44px;
        height: 44px;
        padding: 0;
        border-radius: 50%;
        font-size: 1.4rem;
        line-height: 1;
      }

      .settings-panel {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10;
        padding: 16px;
      }

      .settings-panel.open {
        display: flex;
      }

      .settings-card {
        width: min(1100px, 100%);
        max-height: 90vh;
        background: var(--panel-strong);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 16px;
        overflow: auto;
        display: grid;
        gap: 12px;
      }

      .settings-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }

      .settings-section {
        background: rgba(8, 8, 8, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 14px;
        padding: 12px;
        display: grid;
        gap: 8px;
      }

      .settings-section h3 {
        margin: 0;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .settings-section summary {
        cursor: pointer;
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .settings-section summary::-webkit-details-marker {
        display: none;
      }

      .settings-section summary::after {
        content: ">";
        transform: rotate(90deg);
        transition: transform 0.2s ease;
        opacity: 0.6;
      }

      .settings-section[open] summary::after {
        transform: rotate(270deg);
      }

      label {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      input[type="range"],
      select,
      input[type="text"],
      input[type="color"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(5, 5, 5, 0.7);
        color: inherit;
        font-size: 0.85rem;
      }

      input[type="file"] {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .field {
        display: grid;
        gap: 2px;
      }

      .field.inline {
        grid-template-columns: 1fr auto;
        align-items: center;
      }

      .field.inline span {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .field span {
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 900px) {
        header.toolbar {
          grid-template-columns: 1fr;
          justify-items: center;
          gap: 8px;
        }

        button {
          padding: 8px 10px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body data-layout="fretboard" data-marker-mode="edges" data-marker-shape="dot" data-bg-mode="color" data-scale="on" data-glow="on" data-pulse="on" data-bg-animated="off" data-hue-shift="off" data-control-fill="solid" data-pad-fill="solid">
    <div class="background-layer">
      <img id="bg-image" alt="" />
      <video id="bg-video" muted loop playsinline></video>
    </div>

    <main class="app">
      <header class="toolbar">
        <div class="toolbar-group left">
          <button id="octave-down" class="octave-button octave-pad" type="button" aria-label="Octave down">-</button>
          <button id="octave-up" class="octave-button octave-pad" type="button" aria-label="Octave up">+</button>
        </div>
        <div class="toolbar-center">
          <button id="vibrato-toggle" class="control-button" type="button" aria-pressed="false" aria-label="Vibrato">&nbsp;</button>
        </div>
        <div class="toolbar-group right">
          <button id="settings-button" class="icon-button" type="button" aria-label="Settings">â€¢</button>
        </div>
      </header>

      <div class="fretboard-area">
        <div class="fret-markers" id="markers-top"></div>
        <section class="fretboard" id="fretboard" data-shape="rounded" data-content-mode="blank"></section>
        <section class="drumkit" id="drumkit" data-drum-shape="round" data-content-mode="blank"></section>
        <div class="fret-markers" id="markers-bottom"></div>
        <button id="sustain-toggle" class="sustain-bar control-button" type="button" aria-pressed="false" aria-label="Sustain">&nbsp;</button>
      </div>
    </main>

    <div class="settings-panel" id="settings-panel" aria-hidden="true">
      <div class="settings-card">
        <div class="settings-header">
          <h2>Settings</h2>
          <button id="settings-close" type="button">Close</button>
        </div>
        <div class="settings-grid">
          <div class="settings-section">
            <h3>MIDI</h3>
            <div class="pill" id="midi-status">MIDI: tap refresh</div>
            <div class="field">
              <label for="midi-output">Output</label>
              <select id="midi-output"></select>
            </div>
            <button id="midi-refresh" type="button">Refresh</button>
            <div class="field">
              <span id="midi-status-detail">MIDI: tap refresh to enable.</span>
            </div>
          </div>

          <div class="settings-section">
            <h3>Velocity</h3>
            <div class="field">
              <label for="velocity-mode">Mode</label>
              <select id="velocity-mode">
                <option value="pressure">Pressure</option>
                <option value="fixed">Fixed</option>
              </select>
            </div>
            <div class="field" id="fixed-velocity-field">
              <label for="fixed-velocity">Fixed velocity</label>
              <input id="fixed-velocity" type="range" min="1" max="127" value="96" />
            </div>
            <div class="field" id="pressure-min-field">
              <label for="pressure-min">Pressure min</label>
              <input id="pressure-min" type="range" min="1" max="127" value="30" />
            </div>
            <div class="field" id="pressure-max-field">
              <label for="pressure-max">Pressure max</label>
              <input id="pressure-max" type="range" min="1" max="127" value="120" />
            </div>
            <div class="field" id="touch-sensitivity-field">
              <label for="touch-sensitivity">Touch sensitivity</label>
              <input id="touch-sensitivity" type="range" min="0.2" max="3" value="1" step="0.05" />
              <span id="touch-sensitivity-value">100%</span>
            </div>
            <div class="field" id="touch-curve-field">
              <label for="touch-curve">Touch curve</label>
              <input id="touch-curve" type="range" min="0.5" max="2" value="1" step="0.05" />
              <span id="touch-curve-value">1.00x</span>
            </div>
            <div class="field" id="touch-area-max-field">
              <label for="touch-area-max">Touch area max</label>
              <input id="touch-area-max" type="range" min="200" max="2000" value="900" step="20" />
              <span id="touch-area-max-value">900</span>
            </div>
            <div class="field">
              <span id="pressure-status">Pressure: unknown</span>
            </div>
          </div>

          <div class="settings-section">
            <h3>Vibrato</h3>
            <div class="field">
              <label for="vibrato-rate">Rate</label>
              <input id="vibrato-rate" type="range" min="2" max="12" value="6" step="0.5" />
              <span id="vibrato-rate-value">6.0 Hz</span>
            </div>
            <div class="field">
              <label for="vibrato-depth">Depth</label>
              <input id="vibrato-depth" type="range" min="0" max="12" value="2" step="1" />
              <span id="vibrato-depth-value">2 st</span>
            </div>
          </div>

          <div class="settings-section">
            <h3>Slide Bend</h3>
            <div class="field">
              <label for="bend-mode">Mode</label>
              <select id="bend-mode">
                <option value="off" selected>Off</option>
                <option value="on">On</option>
              </select>
            </div>
          </div>
          </div>

          <div class="settings-section">
            <h3>Controls</h3>
            <div class="field">
              <label for="sustain-mode">Sustain mode</label>
              <select id="sustain-mode">
                <option value="hold" selected>Hold</option>
                <option value="latch">Latch</option>
              </select>
            </div>
          </div>

          <div class="settings-section">
            <h3>Markers</h3>
            <div class="field">
              <label for="marker-mode">Marker mode</label>
              <select id="marker-mode">
                <option value="edges">Edges</option>
                <option value="pads">Pads</option>
                <option value="both">Both</option>
                <option value="off">Off</option>
              </select>
            </div>
            <div class="field">
              <label for="marker-shape">Marker shape</label>
              <select id="marker-shape">
                <option value="dot" selected>Dot</option>
                <option value="bar">Bar</option>
                <option value="square">Square</option>
                <option value="diamond">Diamond</option>
              </select>
            </div>
            <div class="field">
              <label for="marker-offset">Marker offset</label>
              <input id="marker-offset" type="range" min="-30" max="20" value="-6" step="1" />
              <span id="marker-offset-value">-6px</span>
            </div>
            <div class="field">
              <label for="marker-color">Marker color</label>
              <input id="marker-color" type="color" value="#ffffff" />
            </div>
          </div>

          <div class="settings-section">
            <h3>Themes</h3>
            <div class="field">
              <label for="theme-select">Preset</label>
              <select id="theme-select"></select>
            </div>
            <div class="field">
              <span>Applies colors, shape, and content defaults.</span>
            </div>
          </div>

          <div class="settings-section">
            <h3>Randomizer</h3>
            <div class="field">
              <label for="random-mode">Random mode</label>
              <select id="random-mode">
                <option value="off" selected>Off</option>
                <option value="on">On</option>
              </select>
            </div>
            <div class="field">
              <label for="random-chaos">Chaos</label>
              <input id="random-chaos" type="range" min="0" max="100" value="40" step="1" />
              <span id="random-chaos-value">40%</span>
            </div>
            <button id="random-generate" type="button">Generate random</button>
          </div>

          <div class="settings-section">
            <h3>Layout</h3>
            <div class="field">
              <label for="layout-mode">Mode</label>
              <select id="layout-mode">
                <option value="fretboard" selected>Fretboard</option>
                <option value="drum">Drum kit</option>
              </select>
            </div>
            <div class="field" id="drum-style-field">
              <label for="drum-style">Drum style</label>
              <select id="drum-style">
                <option value="round" selected>Round pads</option>
                <option value="kit">Kit cymbals</option>
              </select>
            </div>
            <div class="field" id="row-gap-field">
              <label for="row-gap">String spacing</label>
              <input id="row-gap" type="range" min="-40" max="160" value="-8" step="1" />
              <span id="row-gap-value">-8px</span>
            </div>
          </div>

          <div class="settings-section">
            <h3>Pad style</h3>
            <div class="field">
              <label for="shape-select">Shape</label>
              <select id="shape-select">
                <option value="rounded">Rounded</option>
                <option value="square">Square</option>
                <option value="circle">Circle</option>
                <option value="hex">Hex</option>
                <option value="diamond">Diamond</option>
                <option value="octagon">Octagon</option>
              </select>
            </div>
            <div class="field">
              <label for="corner-radius">Corner radius</label>
              <input id="corner-radius" type="range" min="0" max="32" value="16" />
            </div>
            <div class="field">
              <label for="pad-fill">Pad fill</label>
              <input id="pad-fill" type="color" value="#0a0a0a" />
            </div>
            <div class="field">
              <label for="pad-border">Pad border</label>
              <input id="pad-border" type="color" value="#f5f5f5" />
            </div>
            <div class="field">
              <label for="pad-glow">Pad glow</label>
              <input id="pad-glow" type="color" value="#f5f5f5" />
            </div>
            <div class="field">
              <label for="pad-active">Active fill</label>
              <input id="pad-active" type="color" value="#1a1a1a" />
            </div>
            <div class="field">
              <label for="pad-active-glow">Active glow</label>
              <input id="pad-active-glow" type="color" value="#ffffff" />
            </div>
            <div class="field">
              <label for="color-mode">Color mode</label>
              <select id="color-mode">
                <option value="gradient">String gradient</option>
                <option value="custom" selected>Custom</option>
              </select>
            </div>
            <div class="field" id="gradient-top-field">
              <label for="gradient-top">Gradient top</label>
              <input id="gradient-top" type="color" value="#6ee6ff" />
            </div>
            <div class="field" id="gradient-bottom-field">
              <label for="gradient-bottom">Gradient bottom</label>
              <input id="gradient-bottom" type="color" value="#ffb36a" />
            </div>
          </div>

          <div class="settings-section">
            <h3>Pad content</h3>
            <div class="field">
              <label for="content-mode">Content</label>
              <select id="content-mode">
                <option value="blank">Blank</option>
                <option value="emoji">Emoji/Text</option>
                <option value="image">Image</option>
              </select>
            </div>
            <div class="field" id="emoji-random-field">
              <label for="emoji-random">Emoji random</label>
              <select id="emoji-random">
                <option value="off" selected>Off</option>
                <option value="random">Random</option>
              </select>
            </div>
            <div class="field" id="pad-text-size-field">
              <label for="pad-text-size">Pad text size</label>
              <input id="pad-text-size" type="range" min="16" max="140" value="64" step="1" />
              <span id="pad-text-size-value">64px</span>
            </div>
            <div class="field" id="emoji-rest-field">
              <label for="emoji-rest">Pad text rest</label>
              <input id="emoji-rest" type="text" value="" />
            </div>
            <div class="field" id="emoji-active-field">
              <label for="emoji-active">Pad text active</label>
              <input id="emoji-active" type="text" value="" />
            </div>
            <div class="field" id="image-rest-field">
              <label for="image-rest">Image rest</label>
              <input id="image-rest" type="file" accept="image/*" />
            </div>
            <div class="field" id="image-active-field">
              <label for="image-active">Image active</label>
              <input id="image-active" type="file" accept="image/*" />
            </div>
          </div>

          <div class="settings-section">
            <h3>Custom Presets</h3>
            <div class="field">
              <label for="preset-name">Name</label>
              <input id="preset-name" type="text" placeholder="My preset" />
            </div>
            <button id="preset-save" type="button">Save preset</button>
            <div class="field">
              <label for="preset-select">Saved</label>
              <select id="preset-select"></select>
            </div>
            <div class="toolbar-group">
              <button id="preset-apply" type="button">Apply</button>
              <button id="preset-delete" type="button">Delete</button>
            </div>
          </div>

          <div class="settings-section">
            <h3>Background</h3>
            <div class="field">
              <label for="bg-mode">Background</label>
              <select id="bg-mode">
                <option value="color">Color</option>
                <option value="image">Image</option>
                <option value="video">Video</option>
              </select>
            </div>
            <div class="field">
              <label for="bg-color">Background color</label>
              <input id="bg-color" type="color" value="#000000" />
            </div>
            <div class="field" id="bg-image-field">
              <label for="bg-image-input">Background image</label>
              <input id="bg-image-input" type="file" accept="image/*" />
            </div>
            <div class="field" id="bg-video-field">
              <label for="bg-video-input">Background video</label>
              <input id="bg-video-input" type="file" accept="video/*" />
            </div>
            <div class="field">
              <label for="bg-opacity">Background opacity</label>
              <input id="bg-opacity" type="range" min="0" max="1" value="0.55" step="0.01" />
            </div>
          </div>

          <div class="settings-section">
            <h3>Display</h3>
            <div class="field">
              <label for="control-fill">Controls fill</label>
              <select id="control-fill">
                <option value="solid" selected>Solid</option>
                <option value="outline">Transparent</option>
              </select>
            </div>
            <div class="field">
              <label for="pad-fill-mode">Pads fill</label>
              <select id="pad-fill-mode">
                <option value="solid" selected>Solid</option>
                <option value="outline">Transparent</option>
              </select>
            </div>
          </div>

          <div class="settings-section">
            <h3>Touch FX</h3>
            <div class="field">
              <label for="touch-scale">Scale on touch</label>
              <select id="touch-scale">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
            </div>
            <div class="field">
              <label for="touch-glow">Glow on touch</label>
              <select id="touch-glow">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
            </div>
            <div class="field">
              <label for="pulse-glow">Pulse glow</label>
              <select id="pulse-glow">
                <option value="on" selected>On</option>
                <option value="off">Off</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const nativeMidiBridge = (() => {
        const handler = window.webkit?.messageHandlers?.midi;
        if (!handler) return null;
        let resolver = null;
        return {
          requestAccess() {
            return new Promise((resolve) => {
              resolver = resolve;
              handler.postMessage({ type: "request" });
            });
          },
          _deliver(outputs) {
            if (!resolver) return;
            const outputsMap = new Map();
            (outputs || []).forEach((output) => {
              outputsMap.set(String(output.id), {
                id: String(output.id),
                name: output.name,
                send: (data) => handler.postMessage({ type: "send", outputId: output.id, data }),
              });
            });
            resolver({ outputs: outputsMap });
            resolver = null;
          },
        };
      })();

      if (nativeMidiBridge) {
        window.NativeMidiBridge = nativeMidiBridge;
      }

      async function requestMidiAccess() {
        if (window.NativeMidiBridge) {
          return window.NativeMidiBridge.requestAccess();
        }
        if (navigator.requestMIDIAccess) {
          return navigator.requestMIDIAccess();
        }
        throw new Error("MIDI unavailable");
      }

      const STRINGS = [
        { name: "E4", base: 64 },
        { name: "B3", base: 59 },
        { name: "G3", base: 55 },
        { name: "D3", base: 50 },
        { name: "A2", base: 45 },
        { name: "E2", base: 40 },
      ];
      const FRET_COUNT = 13;
      const MARKER_FRETS = new Set([3, 5, 7, 9, 12]);

      const DRUM_LAYOUT = [
        { id: "crash-1", note: 49, row: 1, col: 1, colSpan: 2, className: "cymbal" },
        { id: "ride", note: 51, row: 1, col: 3, colSpan: 2, className: "cymbal" },
        { id: "crash-2", note: 57, row: 1, col: 5, colSpan: 2, className: "cymbal" },
        { id: "hihat", note: 42, row: 2, col: 1, colSpan: 2, className: "cymbal hihat" },
        { id: "tom-1", note: 50, row: 2, col: 3, colSpan: 2, className: "tom" },
        { id: "tom-2", note: 47, row: 2, col: 5, colSpan: 2, className: "tom" },
        { id: "rim", note: 37, row: 3, col: 1, colSpan: 1, className: "rim" },
        { id: "snare", note: 38, row: 3, col: 2, colSpan: 2, className: "snare" },
        { id: "tom-3", note: 45, row: 3, col: 4, colSpan: 2, className: "tom" },
        { id: "splash", note: 55, row: 3, col: 6, colSpan: 1, className: "cymbal splash" },
        { id: "kick", note: 36, row: 4, col: 2, colSpan: 4, className: "kick" },
      ];

      const fretboard = document.getElementById("fretboard");
      const drumkit = document.getElementById("drumkit");
      const markersTop = document.getElementById("markers-top");
      const markersBottom = document.getElementById("markers-bottom");
      const octaveDown = document.getElementById("octave-down");
      const octaveUp = document.getElementById("octave-up");
      const sustainToggle = document.getElementById("sustain-toggle");
      const vibratoToggle = document.getElementById("vibrato-toggle");
      const midiStatus = document.getElementById("midi-status");
      const settingsButton = document.getElementById("settings-button");
      const settingsPanel = document.getElementById("settings-panel");
      const settingsClose = document.getElementById("settings-close");
      const appRoot = document.querySelector("main.app");
      const toolbar = document.querySelector("header.toolbar");
      const fretboardArea = document.querySelector(".fretboard-area");
      const sustainModeSelect = document.getElementById("sustain-mode");

      const midiOutputSelect = document.getElementById("midi-output");
      const midiRefresh = document.getElementById("midi-refresh");
      const midiStatusDetail = document.getElementById("midi-status-detail");

      const velocityModeSelect = document.getElementById("velocity-mode");
      const fixedVelocityRange = document.getElementById("fixed-velocity");
      const pressureMinRange = document.getElementById("pressure-min");
      const pressureMaxRange = document.getElementById("pressure-max");
      const pressureStatus = document.getElementById("pressure-status");
      const touchSensitivityRange = document.getElementById("touch-sensitivity");
      const touchSensitivityValue = document.getElementById("touch-sensitivity-value");
      const touchSensitivityField = document.getElementById("touch-sensitivity-field");
      const touchCurveRange = document.getElementById("touch-curve");
      const touchCurveValue = document.getElementById("touch-curve-value");
      const touchCurveField = document.getElementById("touch-curve-field");
      const touchAreaMaxRange = document.getElementById("touch-area-max");
      const touchAreaMaxValue = document.getElementById("touch-area-max-value");
      const touchAreaMaxField = document.getElementById("touch-area-max-field");
      const fixedVelocityField = document.getElementById("fixed-velocity-field");
      const pressureMinField = document.getElementById("pressure-min-field");
      const pressureMaxField = document.getElementById("pressure-max-field");

      const markerModeSelect = document.getElementById("marker-mode");
      const markerShapeSelect = document.getElementById("marker-shape");
      const markerOffsetRange = document.getElementById("marker-offset");
      const markerOffsetValue = document.getElementById("marker-offset-value");
      const markerColorInput = document.getElementById("marker-color");
      const controlFillSelect = document.getElementById("control-fill");
      const padFillSelect = document.getElementById("pad-fill-mode");
      const themeSelect = document.getElementById("theme-select");
      const randomModeSelect = document.getElementById("random-mode");
      const randomChaosRange = document.getElementById("random-chaos");
      const randomChaosValue = document.getElementById("random-chaos-value");
      const randomGenerateButton = document.getElementById("random-generate");
      const layoutModeSelect = document.getElementById("layout-mode");
      const drumStyleSelect = document.getElementById("drum-style");
      const drumStyleField = document.getElementById("drum-style-field");
      const rowGapField = document.getElementById("row-gap-field");
      const bendModeSelect = document.getElementById("bend-mode");
      const rowGapRange = document.getElementById("row-gap");
      const rowGapValue = document.getElementById("row-gap-value");

      const shapeSelect = document.getElementById("shape-select");
      const cornerRadiusRange = document.getElementById("corner-radius");
      const padFillInput = document.getElementById("pad-fill");
      const padBorderInput = document.getElementById("pad-border");
      const padGlowInput = document.getElementById("pad-glow");
      const padActiveInput = document.getElementById("pad-active");
      const padActiveGlowInput = document.getElementById("pad-active-glow");
      const colorModeSelect = document.getElementById("color-mode");
      const gradientTopInput = document.getElementById("gradient-top");
      const gradientBottomInput = document.getElementById("gradient-bottom");
      const gradientTopField = document.getElementById("gradient-top-field");
      const gradientBottomField = document.getElementById("gradient-bottom-field");

      const contentModeSelect = document.getElementById("content-mode");
      const emojiRandomSelect = document.getElementById("emoji-random");
      const padTextSizeRange = document.getElementById("pad-text-size");
      const padTextSizeValue = document.getElementById("pad-text-size-value");
      const padTextSizeField = document.getElementById("pad-text-size-field");
      const emojiRestInput = document.getElementById("emoji-rest");
      const emojiActiveInput = document.getElementById("emoji-active");
      const emojiRestField = document.getElementById("emoji-rest-field");
      const emojiActiveField = document.getElementById("emoji-active-field");
      const emojiRandomField = document.getElementById("emoji-random-field");
      const imageRestInput = document.getElementById("image-rest");
      const imageActiveInput = document.getElementById("image-active");
      const imageRestField = document.getElementById("image-rest-field");
      const imageActiveField = document.getElementById("image-active-field");

      const bgModeSelect = document.getElementById("bg-mode");
      const bgColorInput = document.getElementById("bg-color");
      const bgImageInput = document.getElementById("bg-image-input");
      const bgVideoInput = document.getElementById("bg-video-input");
      const bgImageField = document.getElementById("bg-image-field");
      const bgVideoField = document.getElementById("bg-video-field");
      const bgOpacityRange = document.getElementById("bg-opacity");
      const bgImage = document.getElementById("bg-image");
      const bgVideo = document.getElementById("bg-video");

      const touchScaleSelect = document.getElementById("touch-scale");
      const touchGlowSelect = document.getElementById("touch-glow");
      const pulseGlowSelect = document.getElementById("pulse-glow");
      const presetNameInput = document.getElementById("preset-name");
      const presetSaveButton = document.getElementById("preset-save");
      const presetSelect = document.getElementById("preset-select");
      const presetApplyButton = document.getElementById("preset-apply");
      const presetDeleteButton = document.getElementById("preset-delete");

      const vibratoRateRange = document.getElementById("vibrato-rate");
      const vibratoRateValue = document.getElementById("vibrato-rate-value");
      const vibratoDepthRange = document.getElementById("vibrato-depth");
      const vibratoDepthValue = document.getElementById("vibrato-depth-value");

      let midiAccess = null;
      let midiOutput = null;
      let midiRequesting = false;
      let octaveTranspose = 0;
      let sustainActive = false;
      let sustainMode = sustainModeSelect.value;
      let layoutMode = layoutModeSelect.value;
      let drumStyle = drumStyleSelect.value;
      let bendMode = bendModeSelect.value;
      let randomMode = randomModeSelect.value;
      let randomChaos = Number(randomChaosRange.value);
      let activeBendPointerId = null;
      const bendRange = 12;
      let touchSensitivity = Number(touchSensitivityRange.value);
      let touchCurve = Number(touchCurveRange.value);
      let touchAreaMax = Number(touchAreaMaxRange.value);
      let emojiRandomMode = emojiRandomSelect.value;
      let savedPresets = [];
      let vibratoActive = false;
      let vibratoPointerId = null;
      let vibratoRate = Number(vibratoRateRange.value);
      let vibratoDepth = Number(vibratoDepthRange.value);
      let vibratoTimer = null;
      let vibratoPhase = 0;
      let velocityMode = velocityModeSelect.value;
      let fixedVelocity = Number(fixedVelocityRange.value);
      let pressureMin = Number(pressureMinRange.value);
      let pressureMax = Number(pressureMaxRange.value);
      let contentMode = contentModeSelect.value;
      let emojiRest = "";
      let emojiActive = "";
      let padImageUrl = "";
      let padImageActiveUrl = "";
      let bgImageUrl = "";
      let bgVideoUrl = "";
      let padImageData = "";
      let padImageActiveData = "";
      let bgImageData = "";
      let bgVideoData = "";
      let colorMode = colorModeSelect.value;
      const activePointers = new Map();
      const sustainedNotes = new Set();
      const sustainedPads = new Set();

      const themes = [
        {
          id: "mono",
          name: "Mono",
          bgColor: "#000000",
          padFill: "#0a0a0a",
          padBorder: "#f5f5f5",
          padGlow: "#ffffff",
          padActiveFill: "#1a1a1a",
          padActiveGlow: "#ffffff",
          markerColor: "#ffffff",
          shape: "rounded",
          cornerRadius: 16,
          colorMode: "custom",
          contentMode: "blank",
          padTextSize: 64,
        },
        {
          id: "ice",
          name: "Ice Glass",
          bgColor: "#040b11",
          padFill: "#061418",
          padBorder: "#8fe8ff",
          padGlow: "#5dd9ff",
          padActiveFill: "#0f2a31",
          padActiveGlow: "#c8f7ff",
          markerColor: "#c8f7ff",
          shape: "rounded",
          cornerRadius: 18,
          colorMode: "custom",
        },
        {
          id: "amber",
          name: "Amber Glow",
          bgColor: "#120805",
          padFill: "#1a0b07",
          padBorder: "#ffb36a",
          padGlow: "#ff8a3d",
          padActiveFill: "#3a1608",
          padActiveGlow: "#ffd7a0",
          markerColor: "#ffd7a0",
          shape: "rounded",
          cornerRadius: 16,
          colorMode: "custom",
        },
        {
          id: "neon-lime",
          name: "Neon Lime",
          bgColor: "#050a05",
          padFill: "#0c1408",
          padBorder: "#b6ff5a",
          padGlow: "#7dff00",
          padActiveFill: "#223b12",
          padActiveGlow: "#d9ff9f",
          markerColor: "#d9ff9f",
          shape: "rounded",
          cornerRadius: 12,
          colorMode: "custom",
        },
        {
          id: "deep-sea",
          name: "Deep Sea",
          bgColor: "#02060d",
          padFill: "#050d1a",
          padBorder: "#54b5ff",
          padGlow: "#1b7dd1",
          padActiveFill: "#0e1f38",
          padActiveGlow: "#8fd6ff",
          markerColor: "#8fd6ff",
          shape: "circle",
          cornerRadius: 24,
          colorMode: "custom",
        },
        {
          id: "sunset",
          name: "Sunset Fade",
          bgColor: "#120606",
          padFill: "#150909",
          padBorder: "#ff8f8f",
          padGlow: "#ffb36a",
          padActiveFill: "#321010",
          padActiveGlow: "#ffd2b0",
          markerColor: "#ffd2b0",
          shape: "rounded",
          cornerRadius: 20,
          colorMode: "gradient",
          gradientTop: "#ff6a6a",
          gradientBottom: "#ffb36a",
        },
        {
          id: "desert",
          name: "Desert Clay",
          bgColor: "#100b07",
          padFill: "#1b120b",
          padBorder: "#e6c9a8",
          padGlow: "#d7a26f",
          padActiveFill: "#2f1d12",
          padActiveGlow: "#f0dcc7",
          markerColor: "#f0dcc7",
          shape: "square",
          cornerRadius: 6,
          colorMode: "custom",
        },
        {
          id: "electric",
          name: "Electric Blue",
          bgColor: "#02050f",
          padFill: "#060c1a",
          padBorder: "#5ad7ff",
          padGlow: "#2d7cff",
          padActiveFill: "#12284a",
          padActiveGlow: "#a6ecff",
          markerColor: "#a6ecff",
          shape: "hex",
          cornerRadius: 8,
          colorMode: "custom",
        },
        {
          id: "circuit",
          name: "Circuit",
          bgColor: "#030806",
          padFill: "#08150f",
          padBorder: "#4affb1",
          padGlow: "#2aff8c",
          padActiveFill: "#123523",
          padActiveGlow: "#9fffd8",
          markerColor: "#9fffd8",
          shape: "square",
          cornerRadius: 8,
          colorMode: "custom",
        },
        {
          id: "cherry",
          name: "Cherry",
          bgColor: "#120205",
          padFill: "#1a0308",
          padBorder: "#ff5a7a",
          padGlow: "#ff2f5a",
          padActiveFill: "#360812",
          padActiveGlow: "#ffb1c4",
          markerColor: "#ffb1c4",
          shape: "rounded",
          cornerRadius: 14,
          colorMode: "custom",
        },
        {
          id: "mint",
          name: "Mint Pop",
          bgColor: "#03100c",
          padFill: "#051913",
          padBorder: "#68ffd6",
          padGlow: "#2cffc3",
          padActiveFill: "#0e3326",
          padActiveGlow: "#a7ffe6",
          markerColor: "#a7ffe6",
          shape: "rounded",
          cornerRadius: 18,
          colorMode: "custom",
        },
        {
          id: "aurora",
          name: "Aurora",
          bgColor: "#02080c",
          padFill: "#05141b",
          padBorder: "#73ffda",
          padGlow: "#4bd6ff",
          padActiveFill: "#113344",
          padActiveGlow: "#b0fff0",
          markerColor: "#b0fff0",
          shape: "rounded",
          cornerRadius: 20,
          colorMode: "gradient",
          gradientTop: "#6ee6ff",
          gradientBottom: "#9affc2",
        },
        {
          id: "candy",
          name: "Candy",
          bgColor: "#120410",
          padFill: "#1b0818",
          padBorder: "#ff89c6",
          padGlow: "#7de1ff",
          padActiveFill: "#341028",
          padActiveGlow: "#ffd1e9",
          markerColor: "#ffd1e9",
          shape: "circle",
          cornerRadius: 24,
          colorMode: "gradient",
          gradientTop: "#ff89c6",
          gradientBottom: "#7de1ff",
        },
        {
          id: "lava",
          name: "Lava",
          bgColor: "#140402",
          padFill: "#1c0805",
          padBorder: "#ff7b3a",
          padGlow: "#ff451f",
          padActiveFill: "#3a1208",
          padActiveGlow: "#ffb693",
          markerColor: "#ffb693",
          shape: "rounded",
          cornerRadius: 14,
          colorMode: "custom",
        },
        {
          id: "forest",
          name: "Forest Mist",
          bgColor: "#020703",
          padFill: "#09140b",
          padBorder: "#8dff99",
          padGlow: "#3ccf72",
          padActiveFill: "#153524",
          padActiveGlow: "#c6ffd0",
          markerColor: "#c6ffd0",
          shape: "rounded",
          cornerRadius: 18,
          colorMode: "custom",
        },
        {
          id: "steel",
          name: "Steel",
          bgColor: "#0a0a0c",
          padFill: "#121218",
          padBorder: "#d1d6df",
          padGlow: "#8d9bb0",
          padActiveFill: "#1e2230",
          padActiveGlow: "#f2f5f9",
          markerColor: "#f2f5f9",
          shape: "square",
          cornerRadius: 6,
          colorMode: "custom",
        },
        {
          id: "citrus",
          name: "Citrus",
          bgColor: "#0c0a02",
          padFill: "#161203",
          padBorder: "#fff59a",
          padGlow: "#ffd351",
          padActiveFill: "#2a2207",
          padActiveGlow: "#fff6c5",
          markerColor: "#fff6c5",
          shape: "rounded",
          cornerRadius: 16,
          colorMode: "custom",
        },
        {
          id: "rose",
          name: "Rose Gold",
          bgColor: "#12080b",
          padFill: "#1a0c12",
          padBorder: "#f4b5b5",
          padGlow: "#ff9d87",
          padActiveFill: "#362030",
          padActiveGlow: "#ffd9d0",
          markerColor: "#ffd9d0",
          shape: "rounded",
          cornerRadius: 20,
          colorMode: "custom",
        },
        {
          id: "plasma",
          name: "Plasma",
          bgColor: "#0c0414",
          padFill: "#15081f",
          padBorder: "#b68bff",
          padGlow: "#ff6ee7",
          padActiveFill: "#2e123c",
          padActiveGlow: "#e2c7ff",
          markerColor: "#e2c7ff",
          shape: "hex",
          cornerRadius: 8,
          colorMode: "gradient",
          gradientTop: "#9b8cff",
          gradientBottom: "#ff6ee7",
        },
        {
          id: "glacier",
          name: "Glacier Hex",
          bgColor: "#02060f",
          padFill: "#06121f",
          padBorder: "#8fe8ff",
          padGlow: "#4bb6ff",
          padActiveFill: "#102a4b",
          padActiveGlow: "#c5f2ff",
          markerColor: "#c5f2ff",
          shape: "hex",
          cornerRadius: 8,
          colorMode: "custom",
        },
        {
          id: "pixel",
          name: "Pixel Mono",
          bgColor: "#000000",
          padFill: "#0f0f0f",
          padBorder: "#ffffff",
          padGlow: "#ffffff",
          padActiveFill: "#1f1f1f",
          padActiveGlow: "#ffffff",
          markerColor: "#ffffff",
          shape: "square",
          cornerRadius: 4,
          colorMode: "custom",
        },
        {
          id: "orbital",
          name: "Orbital",
          bgColor: "#05060b",
          padFill: "#0d1220",
          padBorder: "#8bd3ff",
          padGlow: "#8bd3ff",
          padActiveFill: "#1c2745",
          padActiveGlow: "#cfe9ff",
          markerColor: "#cfe9ff",
          shape: "circle",
          cornerRadius: 24,
          colorMode: "custom",
        },
        {
          id: "retro",
          name: "Retro Sky",
          bgColor: "#0a0b12",
          padFill: "#111422",
          padBorder: "#76ffe0",
          padGlow: "#ff9ad5",
          padActiveFill: "#1f2a3a",
          padActiveGlow: "#ffd1f0",
          markerColor: "#ffd1f0",
          shape: "rounded",
          cornerRadius: 18,
          colorMode: "gradient",
          gradientTop: "#76ffe0",
          gradientBottom: "#ff9ad5",
        },
        {
          id: "noir-red",
          name: "Noir Red",
          bgColor: "#050000",
          padFill: "#0f0505",
          padBorder: "#ff5a5a",
          padGlow: "#ff1f1f",
          padActiveFill: "#2b0d0d",
          padActiveGlow: "#ff9f9f",
          markerColor: "#ff9f9f",
          shape: "rounded",
          cornerRadius: 14,
          colorMode: "custom",
        },
        {
          id: "ocean",
          name: "Ocean Foam",
          bgColor: "#020a0a",
          padFill: "#071818",
          padBorder: "#7afff5",
          padGlow: "#37e6d8",
          padActiveFill: "#153636",
          padActiveGlow: "#b2fff7",
          markerColor: "#b2fff7",
          shape: "rounded",
          cornerRadius: 18,
          colorMode: "custom",
        },
        {
          id: "violet",
          name: "Violet Pulse",
          bgColor: "#09050f",
          padFill: "#120a1b",
          padBorder: "#c6a0ff",
          padGlow: "#9f6bff",
          padActiveFill: "#261236",
          padActiveGlow: "#dcc7ff",
          markerColor: "#dcc7ff",
          shape: "rounded",
          cornerRadius: 16,
          colorMode: "custom",
        },
        {
          id: "sunbeam",
          name: "Sunbeam",
          bgColor: "#101005",
          padFill: "#181809",
          padBorder: "#ffe07a",
          padGlow: "#ffc857",
          padActiveFill: "#2a2a10",
          padActiveGlow: "#fff1b5",
          markerColor: "#fff1b5",
          shape: "rounded",
          cornerRadius: 16,
          colorMode: "custom",
        },
        {
          id: "prism-drift",
          name: "Prism Drift",
          bgColor: "#050008",
          padFill: "#14001f",
          padBorder: "#ff7aff",
          padGlow: "#6effff",
          padActiveFill: "#2b0140",
          padActiveGlow: "#ffffff",
          markerColor: "#f2b8ff",
          shape: "diamond",
          cornerRadius: 10,
          colorMode: "gradient",
          gradientTop: "#ff7aff",
          gradientBottom: "#6effff",
          bgAnimated: true,
          bgAnimColors: ["#1c0033", "#0c2c4f", "#2a0f3b"],
          hueShift: true,
        },
        {
          id: "aurora-flow",
          name: "Aurora Flow",
          bgColor: "#02060c",
          padFill: "#05141b",
          padBorder: "#73ffda",
          padGlow: "#4bd6ff",
          padActiveFill: "#113344",
          padActiveGlow: "#b0fff0",
          markerColor: "#b0fff0",
          shape: "octagon",
          cornerRadius: 12,
          colorMode: "gradient",
          gradientTop: "#6ee6ff",
          gradientBottom: "#9affc2",
          bgAnimated: true,
          bgAnimColors: ["#031025", "#0d3c3d", "#163a2e"],
          hueShift: true,
        },
        {
          id: "emoji-cascade",
          name: "Emoji Cascade",
          bgColor: "#09090f",
          padFill: "#0b0b15",
          padBorder: "#ffffff",
          padGlow: "#9ad6ff",
          padActiveFill: "#1b1b2a",
          padActiveGlow: "#ffffff",
          markerColor: "#ffffff",
          shape: "rounded",
          cornerRadius: 18,
          colorMode: "custom",
          contentMode: "emoji",
          emojiRest: "âœ¨ ðŸŒˆ ðŸ’Ž ðŸ«§ ðŸª©",
          emojiActive: "âš¡ï¸ ðŸ”¥ ðŸ’¥ ðŸŒŸ",
          emojiRandom: true,
          padTextSize: 60,
          bgAnimated: true,
          bgAnimColors: ["#12041f", "#15223f", "#1b1030"],
        },
      ];

      function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
      }

      function hexToRgb(hex) {
        const value = hex.replace("#", "");
        if (value.length !== 6) return { r: 0, g: 0, b: 0 };
        return {
          r: parseInt(value.slice(0, 2), 16),
          g: parseInt(value.slice(2, 4), 16),
          b: parseInt(value.slice(4, 6), 16),
        };
      }

      function mixColor(a, b, t) {
        return {
          r: Math.round(a.r + (b.r - a.r) * t),
          g: Math.round(a.g + (b.g - a.g) * t),
          b: Math.round(a.b + (b.b - a.b) * t),
        };
      }

      function rgbToCss(color, alpha) {
        return `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`;
      }

      function buildMarkers() {
        markersTop.innerHTML = "";
        markersBottom.innerHTML = "";
        for (let i = 0; i < FRET_COUNT; i += 1) {
          const topDot = document.createElement("div");
          const bottomDot = document.createElement("div");
          topDot.className = "marker-dot";
          bottomDot.className = "marker-dot";
          if (MARKER_FRETS.has(i)) {
            topDot.classList.add("marker");
            bottomDot.classList.add("marker");
          }
          markersTop.appendChild(topDot);
          markersBottom.appendChild(bottomDot);
        }
      }

      function buildFretboard() {
        fretboard.innerHTML = "";
        STRINGS.forEach((stringInfo, rowIndex) => {
          const row = document.createElement("div");
          row.className = "string-row";
          row.dataset.row = rowIndex;
          for (let fretIndex = 0; fretIndex < FRET_COUNT; fretIndex += 1) {
            const pad = document.createElement("div");
            pad.className = "pad";
            pad.dataset.layout = "fretboard";
            pad.dataset.row = rowIndex;
            pad.dataset.fret = fretIndex;
            if (MARKER_FRETS.has(fretIndex)) {
              pad.classList.add("marker");
            }
            const emojiSpan = document.createElement("span");
            emojiSpan.className = "pad-emoji";
            pad.appendChild(emojiSpan);
            row.appendChild(pad);
          }
          fretboard.appendChild(row);
        });
        updateNotes();
        applyRowColors();
        updatePadEmoji();
      }

      function buildDrumKit() {
        drumkit.innerHTML = "";
        DRUM_LAYOUT.forEach((drum) => {
          const pad = document.createElement("div");
          pad.className = `drum-pad ${drum.className || ""}`.trim();
          pad.dataset.note = String(drum.note);
          pad.dataset.layout = "drum";
          pad.style.gridColumn = `${drum.col} / span ${drum.colSpan || 1}`;
          pad.style.gridRow = `${drum.row} / span ${drum.rowSpan || 1}`;
          const emojiSpan = document.createElement("span");
          emojiSpan.className = "pad-emoji";
          pad.appendChild(emojiSpan);
          drumkit.appendChild(pad);
        });
        updatePadEmoji();
      }


      function updateNotes() {
        const pads = document.querySelectorAll(".pad, .drum-pad");
        pads.forEach((pad) => {
          const rowIndex = Number(pad.dataset.row);
          const fretIndex = Number(pad.dataset.fret);
          const baseNote = STRINGS[rowIndex].base + octaveTranspose * 12;
          const midiNote = baseNote + fretIndex;
          pad.dataset.note = String(midiNote);
        });
      }

      function applyRowColors() {
        const rows = fretboard.querySelectorAll(".string-row");
        if (colorMode !== "gradient") {
          rows.forEach((row) => {
            row.style.removeProperty("--row-border");
            row.style.removeProperty("--row-glow");
          });
          return;
        }
        const topColor = hexToRgb(gradientTopInput.value || "#6ee6ff");
        const bottomColor = hexToRgb(gradientBottomInput.value || "#ffb36a");
        const lastIndex = Math.max(1, rows.length - 1);
        rows.forEach((row, index) => {
          const t = index / lastIndex;
          const mixed = mixColor(topColor, bottomColor, t);
          row.style.setProperty("--row-border", rgbToCss(mixed, 0.75));
          row.style.setProperty("--row-glow", rgbToCss(mixed, 0.45));
        });
      }

      function populateThemes() {
        themeSelect.innerHTML = "";
        themes.forEach((theme) => {
          const option = document.createElement("option");
          option.value = theme.id;
          option.textContent = theme.name;
          themeSelect.appendChild(option);
        });
      }

      function applyTheme(theme) {
        if (!theme) return;
        if (theme.bgColor) {
          bgColorInput.value = theme.bgColor;
          document.documentElement.style.setProperty("--bg-color", theme.bgColor);
        }
        if (theme.padFill) {
          padFillInput.value = theme.padFill;
          document.documentElement.style.setProperty("--pad-fill", theme.padFill);
        }
        if (theme.padBorder) {
          padBorderInput.value = theme.padBorder;
          document.documentElement.style.setProperty("--pad-border", theme.padBorder);
        }
        if (theme.padGlow) {
          padGlowInput.value = theme.padGlow;
          document.documentElement.style.setProperty("--pad-glow", theme.padGlow);
        }
        if (theme.padActiveFill) {
          padActiveInput.value = theme.padActiveFill;
          document.documentElement.style.setProperty("--pad-active-fill", theme.padActiveFill);
        }
        if (theme.padActiveGlow) {
          padActiveGlowInput.value = theme.padActiveGlow;
          document.documentElement.style.setProperty("--pad-active-glow", theme.padActiveGlow);
        }
        if (theme.markerColor) {
          markerColorInput.value = theme.markerColor;
          document.documentElement.style.setProperty("--marker-color", theme.markerColor);
        }
        if (theme.shape) {
          shapeSelect.value = theme.shape;
          fretboard.dataset.shape = theme.shape;
        }
        if (theme.cornerRadius != null) {
          cornerRadiusRange.value = String(theme.cornerRadius);
          document.documentElement.style.setProperty("--pad-radius", `${theme.cornerRadius}px`);
        }
        if (theme.colorMode) {
          colorModeSelect.value = theme.colorMode;
          colorMode = theme.colorMode;
          updateColorModeFields();
        }
        if (theme.gradientTop) {
          gradientTopInput.value = theme.gradientTop;
        }
        if (theme.gradientBottom) {
          gradientBottomInput.value = theme.gradientBottom;
        }
        applyRowColors();
        if (theme.contentMode) {
          contentModeSelect.value = theme.contentMode;
          contentMode = theme.contentMode;
          fretboard.dataset.contentMode = contentMode;
          drumkit.dataset.contentMode = contentMode;
          updateContentFields();
        }
        if (theme.emojiRest != null) {
          emojiRestInput.value = theme.emojiRest;
          emojiRest = theme.emojiRest;
        }
        if (theme.emojiActive != null) {
          emojiActiveInput.value = theme.emojiActive;
          emojiActive = theme.emojiActive;
        }
        if (theme.padTextSize != null) {
          setPadTextSize(theme.padTextSize);
        }
        if (theme.rowGap != null) {
          setRowGap(theme.rowGap);
        }
        const wantsEmojiRandom = theme.emojiRandom === true;
        emojiRandomSelect.value = wantsEmojiRandom ? "random" : "off";
        emojiRandomMode = emojiRandomSelect.value;
        document.body.dataset.bgAnimated = theme.bgAnimated ? "on" : "off";
        if (theme.bgAnimColors) {
          document.documentElement.style.setProperty("--bg-anim-a", theme.bgAnimColors[0]);
          document.documentElement.style.setProperty("--bg-anim-b", theme.bgAnimColors[1]);
          document.documentElement.style.setProperty("--bg-anim-c", theme.bgAnimColors[2]);
        }
        document.body.dataset.hueShift = theme.hueShift ? "on" : "off";
        updatePadEmoji();
      }

      function setLayoutMode(mode, options = {}) {
        layoutMode = mode;
        document.body.dataset.layout = mode;
        const isDrum = mode === "drum";
        drumStyleField.classList.toggle("hidden", !isDrum);
        rowGapField.classList.toggle("hidden", isDrum);
        if (!options.skipBuild) {
          if (isDrum) {
            buildDrumKit();
          } else {
            buildFretboard();
          }
        }
        stopAllNotes();
      }

      function setDrumStyle(value) {
        drumStyle = value;
        drumkit.dataset.drumShape = value;
      }

      function setBendMode(value) {
        bendMode = value;
        if (bendMode === "on") {
          setPitchBendRange(bendRange);
        } else {
          sendPitchBend(0);
          activeBendPointerId = null;
        }
      }

      function setMarkerOffset(value) {
        const clamped = clamp(Number(value), -30, 20);
        markerOffsetRange.value = String(clamped);
        document.documentElement.style.setProperty("--marker-offset", `${clamped}px`);
        markerOffsetValue.textContent = `${clamped}px`;
      }

      function setRandomChaos(value) {
        const clamped = clamp(Number(value), 0, 100);
        randomChaos = clamped;
        randomChaosRange.value = String(clamped);
        randomChaosValue.textContent = `${clamped}%`;
      }

      function pickRandom(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function randomBetween(min, max) {
        return min + Math.random() * (max - min);
      }

      function randomHsl(h, s, l) {
        return `hsl(${Math.round(h)}, ${Math.round(s)}%, ${Math.round(l)}%)`;
      }

      function applyRandomTheme() {
        const chaos = clamp(randomChaos, 0, 100) / 100;
        const useColor = chaos > 0.15;
        const baseHue = Math.random() * 360;
        const accentHue = (baseHue + randomBetween(40, 160)) % 360;
        const sat = useColor ? randomBetween(35, 85) : 0;
        const bgLight = useColor ? randomBetween(4, 12) : randomBetween(0, 6);
        const padLight = useColor ? randomBetween(8, 18) : randomBetween(6, 12);
        const borderLight = useColor ? randomBetween(65, 90) : randomBetween(80, 98);
        const glowLight = useColor ? randomBetween(60, 90) : randomBetween(85, 100);

        const bgColor = randomHsl(baseHue, sat * 0.2, bgLight);
        const padFill = randomHsl(baseHue, sat * 0.35, padLight);
        const padBorder = randomHsl(accentHue, sat, borderLight);
        const padGlow = randomHsl(accentHue, sat, glowLight);
        const padActiveFill = randomHsl(baseHue, sat * 0.5, padLight + 8);
        const padActiveGlow = randomHsl(accentHue, sat, glowLight + 4);

        bgColorInput.value = bgColor;
        document.documentElement.style.setProperty("--bg-color", bgColor);
        padFillInput.value = padFill;
        document.documentElement.style.setProperty("--pad-fill", padFill);
        padBorderInput.value = padBorder;
        document.documentElement.style.setProperty("--pad-border", padBorder);
        padGlowInput.value = padGlow;
        document.documentElement.style.setProperty("--pad-glow", padGlow);
        padActiveInput.value = padActiveFill;
        document.documentElement.style.setProperty("--pad-active-fill", padActiveFill);
        padActiveGlowInput.value = padActiveGlow;
        document.documentElement.style.setProperty("--pad-active-glow", padActiveGlow);
        markerColorInput.value = padActiveGlow;
        document.documentElement.style.setProperty("--marker-color", padActiveGlow);

        const useGradient = chaos > 0.35 && Math.random() < chaos;
        colorMode = useGradient ? "gradient" : "custom";
        colorModeSelect.value = colorMode;
        updateColorModeFields();
        if (useGradient) {
          gradientTopInput.value = randomHsl(baseHue, sat, randomBetween(40, 70));
          gradientBottomInput.value = randomHsl(accentHue, sat, randomBetween(40, 70));
        }
        applyRowColors();

        const shapes = chaos > 0.6 ? ["rounded", "circle", "hex", "diamond", "octagon", "square"] : ["rounded", "square", "circle"];
        shapeSelect.value = pickRandom(shapes);
        fretboard.dataset.shape = shapeSelect.value;

        const wantsEmoji = chaos > 0.55 && Math.random() < chaos;
        contentMode = wantsEmoji ? "emoji" : "blank";
        contentModeSelect.value = contentMode;
        fretboard.dataset.contentMode = contentMode;
        drumkit.dataset.contentMode = contentMode;
        updateContentFields();

        if (wantsEmoji) {
          const emojiSets = [
            "âœ¨ ðŸŒˆ ðŸ’Ž ðŸ«§ ðŸª©",
            "ðŸ”¥ âš¡ï¸ ðŸ’¥ ðŸŒŸ",
            "ðŸŒŠ ðŸŒ™ ðŸŒ«ï¸ ðŸ’§",
            "ðŸŠ ðŸ“ ðŸ« ðŸ‹",
            "ðŸª ðŸŒŒ ðŸš€ ðŸ›°ï¸",
          ];
          const emojiActiveSets = [
            "âš¡ï¸ ðŸ’¥ ðŸ”¥",
            "âœ¨ ðŸŒŸ ðŸ’«",
            "ðŸ”¥ ðŸŒªï¸ ðŸ’£",
            "ðŸ«§ ðŸŒˆ ðŸ’¥",
          ];
          emojiRest = pickRandom(emojiSets);
          emojiActive = pickRandom(emojiActiveSets);
          emojiRestInput.value = emojiRest;
          emojiActiveInput.value = emojiActive;
          emojiRandomMode = chaos > 0.7 ? "random" : "off";
          emojiRandomSelect.value = emojiRandomMode;
        }

        const textSize = Math.round(randomBetween(30, 110) * (0.4 + chaos));
        setPadTextSize(textSize);

        const animateBg = chaos > 0.6 && Math.random() < chaos;
        document.body.dataset.bgAnimated = animateBg ? "on" : "off";
        if (animateBg) {
          document.documentElement.style.setProperty("--bg-anim-a", randomHsl(baseHue, sat, 18));
          document.documentElement.style.setProperty("--bg-anim-b", randomHsl(accentHue, sat, 20));
          document.documentElement.style.setProperty("--bg-anim-c", randomHsl((accentHue + 90) % 360, sat, 22));
        }
        document.body.dataset.hueShift = chaos > 0.8 && Math.random() < chaos ? "on" : "off";

        themeSelect.value = "";
        updatePadEmoji();
      }

      function makeSettingsCollapsible() {
        const sections = Array.from(document.querySelectorAll(".settings-section"));
        sections.forEach((section, index) => {
          if (section.tagName.toLowerCase() == "details") return;
          const title = section.querySelector("h3");
          if (!title) return;
          const details = document.createElement("details");
          details.className = section.className;
          if (index < 2) {
            details.open = true;
          }
          const summary = document.createElement("summary");
          summary.textContent = title.textContent;
          summary.className = "settings-summary";
          title.remove();
          details.appendChild(summary);
          while (section.firstChild) {
            details.appendChild(section.firstChild);
          }
          section.replaceWith(details);
        });
      }

      function loadPresets() {
        const raw = localStorage.getItem("touchfret-presets");
        savedPresets = raw ? JSON.parse(raw) : [];
        updatePresetSelect();
      }

      function updatePresetSelect() {
        presetSelect.innerHTML = "";
        if (!savedPresets.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No presets";
          presetSelect.appendChild(option);
          presetSelect.disabled = true;
          return;
        }
        presetSelect.disabled = false;
        savedPresets.forEach((preset) => {
          const option = document.createElement("option");
          option.value = preset.id;
          option.textContent = preset.name;
          presetSelect.appendChild(option);
        });
      }

      function collectSettings() {
        const values = {};
        const skip = new Set(["theme-select", "midi-output", "preset-name", "preset-select"]);
        settingsPanel.querySelectorAll("input, select").forEach((el) => {
          if (!el.id || el.type === "file" || skip.has(el.id)) return;
          values[el.id] = el.value;
        });
        return {
          id: typeof crypto !== "undefined" && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
          name: presetNameInput.value.trim() || `Preset ${savedPresets.length + 1}`,
          values,
          datasets: {
            bgAnimated: document.body.dataset.bgAnimated,
            hueShift: document.body.dataset.hueShift,
          },
          media: {
            padImageData,
            padImageActiveData,
            bgImageData,
            bgVideoData,
          },
        };
      }

      function applySettings(preset) {
        if (!preset) return;
        const values = preset.values || {};
        Object.entries(values).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.value = value;
          const eventType = el.tagName === "SELECT" ? "change" : "input";
          el.dispatchEvent(new Event(eventType));
        });

        if (preset.datasets) {
          document.body.dataset.bgAnimated = preset.datasets.bgAnimated || "off";
          document.body.dataset.hueShift = preset.datasets.hueShift || "off";
        }

        if (preset.media) {
          padImageData = preset.media.padImageData || "";
          padImageActiveData = preset.media.padImageActiveData || "";
          bgImageData = preset.media.bgImageData || "";
          bgVideoData = preset.media.bgVideoData || "";

          if (padImageData) {
            setPadImage(padImageData);
          }
          if (padImageActiveData) {
            setPadImageActive(padImageActiveData);
          }
          if (bgImageData) {
            bgImage.src = bgImageData;
          }
          if (bgVideoData) {
            bgVideo.src = bgVideoData;
            bgVideo.play().catch(() => {});
          }
        }

        updateBackgroundFields();
        updateContentFields();
        applyRowColors();
        updatePadEmoji();
      }

      function savePresets() {
        localStorage.setItem("touchfret-presets", JSON.stringify(savedPresets));
        updatePresetSelect();
      }

      function setSettingsOpen(open) {
        settingsPanel.classList.toggle("open", open);
        settingsPanel.setAttribute("aria-hidden", String(!open));
      }

      function sendMidi(message) {
        if (midiOutput) {
          midiOutput.send(message);
        }
      }

      function noteOn(midiNote, velocity) {
        sendMidi([0x90, midiNote, velocity]);
      }

      function noteOff(midiNote) {
        sendMidi([0x80, midiNote, 0x00]);
      }
      function sendPitchBend(amount) {
        const value = clamp(amount, -1, 1);
        const range = Math.round(8192 * value);
        const bend = clamp(8192 + range, 0, 16383);
        sendMidi([0xe0, bend & 0x7f, (bend >> 7) & 0x7f]);
      }

      function setPitchBendRange(semitones) {
        if (!midiOutput) return;
        const value = clamp(Math.round(semitones), 0, 24);
        sendMidi([0xb0, 0x65, 0x00]);
        sendMidi([0xb0, 0x64, 0x00]);
        sendMidi([0xb0, 0x06, value]);
        sendMidi([0xb0, 0x26, 0x00]);
        sendMidi([0xb0, 0x65, 0x7f]);
        sendMidi([0xb0, 0x64, 0x7f]);
      }

      function startVibrato() {
        if (vibratoTimer) return;
        vibratoPhase = 0;
        const tickRate = 60;
        vibratoTimer = setInterval(() => {
          const depth = clamp(vibratoDepth, 0, 12) / 12;
          const amount = Math.sin(vibratoPhase) * depth;
          vibratoPhase += (2 * Math.PI * vibratoRate) / tickRate;
          sendPitchBend(amount);
        }, 1000 / tickRate);
      }

      function stopVibrato() {
        if (vibratoTimer) {
          clearInterval(vibratoTimer);
          vibratoTimer = null;
        }
        sendPitchBend(0);
      }

      function setVibratoActive(active) {
        vibratoActive = active;
        vibratoToggle.setAttribute("aria-pressed", String(active));
        if (active) {
          startVibrato();
        } else {
          stopVibrato();
        }
      }

      function setVibratoRate(value) {
        const clamped = clamp(Number(value), 1, 12);
        vibratoRate = clamped;
        vibratoRateRange.value = String(clamped);
        vibratoRateValue.textContent = `${clamped.toFixed(1)} Hz`;
      }

      function setVibratoDepth(value) {
        const clamped = clamp(Number(value), 0, 12);
        vibratoDepth = clamped;
        vibratoDepthRange.value = String(clamped);
        vibratoDepthValue.textContent = `${clamped} st`;
      }

      function isNoteHeldByOthers(midiNote, pointerId) {
        for (const [id, data] of activePointers.entries()) {
          if (id === pointerId) continue;
          if (data.note === midiNote) return true;
        }
        return false;
      }

      function isPadHeldByOthers(pad, pointerId) {
        for (const [id, data] of activePointers.entries()) {
          if (id === pointerId) continue;
          if (data.pad === pad) return true;
        }
        return false;
      }

      function isNoteHeld(midiNote) {
        for (const data of activePointers.values()) {
          if (data.note === midiNote) return true;
        }
        return false;
      }

      function setSustainActive(active) {
        sustainActive = active;
        sustainToggle.setAttribute("aria-pressed", String(active));
        if (!active) {
          releaseSustainedNotes();
        }
      }

      function clearSustainedPads() {
        sustainedPads.forEach((pad) => {
          if (!isPadHeld(pad)) {
            pad.classList.remove("active");
            setPadEmoji(pad, false);
          }
        });
        sustainedPads.clear();
      }

      function isPadHeld(pad) {
        for (const data of activePointers.values()) {
          if (data.pad === pad) return true;
        }
        return false;
      }

      function releaseSustainedNotes() {
        sustainedNotes.forEach((note) => {
          if (!isNoteHeld(note)) {
            noteOff(note);
          }
        });
        sustainedNotes.clear();
        clearSustainedPads();
      }

      function getPressure(event) {
        if (event.pointerType === "mouse") {
          return 0;
        }
        const events = typeof event.getCoalescedEvents === "function" ? event.getCoalescedEvents() : [event];
        let best = 0;
        for (const entry of events) {
          const width = entry.width || (entry.radiusX ? entry.radiusX * 2 : 0);
          const height = entry.height || (entry.radiusY ? entry.radiusY * 2 : 0);
          let pressure = 0;
          if (entry.pointerType === "touch" && width && height) {
            const area = width * height;
            const normalized = clamp(area / touchAreaMax, 0, 1);
            pressure = Math.pow(normalized, touchCurve);
          } else if (typeof entry.pressure === "number" && entry.pressure > 0) {
            pressure = entry.pressure;
          } else if (typeof entry.force === "number" && entry.force > 0) {
            pressure = entry.force;
          } else if (typeof entry.webkitForce === "number" && entry.webkitForce > 0) {
            pressure = entry.webkitForce;
          } else if (width && height) {
            const area = width * height;
            const normalized = clamp(area / touchAreaMax, 0, 1);
            pressure = Math.pow(normalized, touchCurve);
          }
          if (pressure > best) {
            best = pressure;
          }
        }
        return best;
      }

      function getVelocity(event) {
        if (velocityMode === "pressure") {
          const pressure = getPressure(event);
          if (pressure > 0) {
            const scaled = clamp(pressure * touchSensitivity, 0, 1);
            return clamp(Math.round(pressureMin + scaled * (pressureMax - pressureMin)), 1, 127);
          }
        }
        return clamp(Math.round(fixedVelocity), 1, 127);
      }

      function parseEmojiList(value) {
        return value
          .split(/[,]+|\s+/)
          .map((item) => item.trim())
          .filter(Boolean);
      }

      function pickEmoji(list) {
        if (!list.length) return "";
        return list[Math.floor(Math.random() * list.length)];
      }

      function setPadEmoji(pad, active) {
        if (contentMode !== "emoji") return;
        const span = pad.querySelector(".pad-emoji");
        if (!span) return;
        if (emojiRandomMode !== "random") {
          span.textContent = active && emojiActive ? emojiActive : emojiRest;
          return;
        }
        const list = parseEmojiList(active ? emojiActive : emojiRest);
        const pick = pickEmoji(list);
        if (active) {
          pad.dataset.emojiActivePick = pick;
        } else {
          pad.dataset.emojiRestPick = pick;
        }
        span.textContent = pick;
      }

      function updatePadEmoji() {
        const pads = document.querySelectorAll(".pad, .drum-pad");
        pads.forEach((pad) => {
          if (emojiRandomMode !== "random") {
            delete pad.dataset.emojiActivePick;
            delete pad.dataset.emojiRestPick;
          }
          setPadEmoji(pad, pad.classList.contains("active"));
        });
      }
      function pressPad(pad, velocity, pointerId) {
        const midiNote = Number(pad.dataset.note);
        const rowIndex = pad.dataset.row ? Number(pad.dataset.row) : null;
        const layout = pad.dataset.layout || "fretboard";
        const bendEligible = bendMode === "on" && layout === "fretboard" && activeBendPointerId === pointerId;
        activePointers.set(pointerId, {
          pad,
          note: midiNote,
          originNote: midiNote,
          originRow: rowIndex,
          row: rowIndex,
          layout,
          bendEligible,
        });
        pad.classList.add("active");
        setPadEmoji(pad, true);
        noteOn(midiNote, velocity);
      }

      function releasePad(pad, pointerId, options = {}) {
        if (!pad) return;
        const data = activePointers.get(pointerId);
        if (!data) return;
        const midiNote = data.note;
        activePointers.delete(pointerId);
        const shouldReleaseVisual = !isPadHeldByOthers(pad, pointerId);
        if (sustainActive) {
          sustainedNotes.add(midiNote);
          if (shouldReleaseVisual) {
            sustainedPads.add(pad);
          }
        } else {
          if (shouldReleaseVisual) {
            pad.classList.remove("active");
            setPadEmoji(pad, false);
          }
          if (!isNoteHeldByOthers(midiNote, pointerId)) {
            noteOff(midiNote);
          }
        }

        if (data.bendEligible && activeBendPointerId == pointerId && !options.keepBendPointer) {
          sendPitchBend(0);
          activeBendPointerId = null;
        }
      }

      function handlePointerDown(event) {
        const pad = event.target.closest(".pad, .drum-pad");
        event.preventDefault();
        if (!midiAccess && (navigator.requestMIDIAccess || window.NativeMidiBridge)) {
          initMidi();
        }
        if (!pad) {
          if (!activePointers.has(event.pointerId)) {
            activePointers.set(event.pointerId, { pad: null, note: null });
          }
          return;
        }
        if (bendMode === "on" && activeBendPointerId == null && pad.dataset.layout !== "drum") {
          activeBendPointerId = event.pointerId;
        }
        const velocity = getVelocity(event);
        pressPad(pad, velocity, event.pointerId);
      }

      function handlePointerMove(event) {
        if (!activePointers.has(event.pointerId)) return;
        event.preventDefault();
        const element = document.elementFromPoint(event.clientX, event.clientY);
        const pad = element ? element.closest(".pad, .drum-pad") : null;
        const current = activePointers.get(event.pointerId);
        if (!current) return;
        if (!pad) return;
        if (!current.pad) {
          const velocity = getVelocity(event);
          pressPad(pad, velocity, event.pointerId);
          return;
        }
        if (pad === current.pad) return;

        const padLayout = pad.dataset.layout || "fretboard";
        if (bendMode === "on" && current.bendEligible && current.layout === "fretboard" && padLayout === "fretboard") {
          const targetRow = pad.dataset.row ? Number(pad.dataset.row) : null;
          if (targetRow != null && targetRow === current.originRow) {
            const targetNote = Number(pad.dataset.note);
            const offset = targetNote - current.originNote;
            const normalized = clamp(offset / bendRange, -1, 1);
            sendPitchBend(normalized);
            if (pad !== current.pad) {
              if (!isPadHeldByOthers(current.pad, event.pointerId)) {
                current.pad.classList.remove("active");
                setPadEmoji(current.pad, false);
              }
              current.pad = pad;
              current.row = targetRow;
              pad.classList.add("active");
              setPadEmoji(pad, true);
            }
            return;
          }
        }

        if (current.bendEligible) {
          sendPitchBend(0);
        }
        releasePad(current.pad, event.pointerId, { keepBendPointer: true });
        const velocity = getVelocity(event);
        pressPad(pad, velocity, event.pointerId);
      }

      function handlePointerUp(event) {
        const current = activePointers.get(event.pointerId);
        if (!current) return;
        if (current.pad) {
          releasePad(current.pad, event.pointerId);
        } else {
          activePointers.delete(event.pointerId);
        }
      }

      function stopAllNotes() {
        for (const data of activePointers.values()) {
          if (data.note != null) {
            noteOff(data.note);
          }
        }
        sustainedNotes.forEach((note) => {
          noteOff(note);
        });
        activePointers.clear();
        sustainedNotes.clear();
        clearSustainedPads();
        sendPitchBend(0);
        activeBendPointerId = null;
        document.querySelectorAll(".pad.active, .drum-pad.active").forEach((pad) => {
          pad.classList.remove("active");
          setPadEmoji(pad, false);
        });
      }

      async function initMidi() {
        if (midiRequesting) return;
        midiRequesting = true;
        if (!navigator.requestMIDIAccess && !window.NativeMidiBridge) {
          midiStatus.textContent = "MIDI: unavailable";
          midiStatusDetail.textContent = "MIDI: unavailable (needs WebMIDI or app).";
          midiRequesting = false;
          return;
        }
        try {
          midiAccess = await requestMidiAccess();
          midiStatus.textContent = "MIDI: ready";
          midiStatusDetail.textContent = "MIDI: ready.";
          refreshMidiOutputs();
        } catch (error) {
          midiStatus.textContent = "MIDI: blocked";
          midiStatusDetail.textContent = "MIDI: blocked (try refresh).";
        } finally {
          midiRequesting = false;
        }
      }

      function refreshMidiOutputs() {
        midiOutputSelect.innerHTML = "";
        if (!midiAccess) {
          midiStatusDetail.textContent = "MIDI: unavailable.";
          return;
        }
        const outputs = Array.from(midiAccess.outputs.values());
        if (!outputs.length) {
          midiStatusDetail.textContent = "MIDI: no outputs.";
          midiStatus.textContent = "MIDI: none";
          midiOutput = null;
          return;
        }
        const preferred =
          outputs.find((output) => /idam/i.test(output.name || "")) ||
          outputs.find((output) => /adam/i.test(output.name || "")) ||
          outputs[0];
        const preferredId = String(preferred.id);
        outputs.forEach((output, index) => {
          const option = document.createElement("option");
          option.value = String(output.id);
          option.textContent = output.name || `Output ${index + 1}`;
          if (String(output.id) === preferredId) {
            option.selected = true;
          }
          midiOutputSelect.appendChild(option);
        });
        midiOutputSelect.value = preferredId;
        midiOutput = outputs.find((output) => String(output.id) === preferredId) || outputs[0];
        midiStatus.textContent = `MIDI: ${midiOutput.name || "connected"}`;
        midiStatusDetail.textContent = `MIDI: ${midiOutput.name || "connected"}.`;
        if (bendMode === "on") {
          setPitchBendRange(bendRange);
        }
      }

      midiOutputSelect.addEventListener("change", (event) => {
        const outputId = event.target.value;
        midiOutput = midiAccess?.outputs.get(outputId) || null;
        midiStatus.textContent = midiOutput ? `MIDI: ${midiOutput.name || "connected"}` : "MIDI: none";
        midiStatusDetail.textContent = midiOutput
          ? `MIDI: ${midiOutput.name || "connected"}.`
          : "MIDI: choose output.";
        sendPitchBend(0);
      });

      midiRefresh.addEventListener("click", () => {
        if (window.NativeMidiBridge || !midiAccess) {
          initMidi();
          return;
        }
        refreshMidiOutputs();
      });

      octaveDown.addEventListener("click", () => {
        octaveTranspose = clamp(octaveTranspose - 1, -3, 3);
        stopAllNotes();
        updateNotes();
      });

      octaveUp.addEventListener("click", () => {
        octaveTranspose = clamp(octaveTranspose + 1, -3, 3);
        stopAllNotes();
        updateNotes();
      });

      sustainToggle.addEventListener("pointerdown", (event) => {
        event.preventDefault();
        sustainToggle.setPointerCapture(event.pointerId);
        if (sustainMode === "hold") {
          setSustainActive(true);
          return;
        }
        setSustainActive(!sustainActive);
      });

      ["pointerup", "pointercancel", "lostpointercapture"].forEach((eventName) => {
        sustainToggle.addEventListener(eventName, () => {
          if (sustainMode === "hold") {
            setSustainActive(false);
          }
        });
      });

      sustainModeSelect.addEventListener("change", () => {
        sustainMode = sustainModeSelect.value;
        if (sustainMode === "hold") {
          setSustainActive(false);
        }
      });

      vibratoToggle.addEventListener("pointerdown", (event) => {
        event.preventDefault();
        vibratoToggle.setPointerCapture(event.pointerId);
        vibratoPointerId = event.pointerId;
        setVibratoActive(true);
      });

      ["pointerup", "pointercancel", "lostpointercapture"].forEach((eventName) => {
        vibratoToggle.addEventListener(eventName, (event) => {
          if (vibratoPointerId !== event.pointerId) return;
          vibratoPointerId = null;
          setVibratoActive(false);
        });
      });

      vibratoRateRange.addEventListener("input", () => {
        setVibratoRate(vibratoRateRange.value);
      });

      vibratoDepthRange.addEventListener("input", () => {
        setVibratoDepth(vibratoDepthRange.value);
      });

      settingsButton.addEventListener("click", () => {
        setSettingsOpen(true);
        initMidi();
      });
      settingsClose.addEventListener("click", () => setSettingsOpen(false));
      settingsPanel.addEventListener("click", (event) => {
        if (event.target === settingsPanel) {
          setSettingsOpen(false);
        }
      });

      velocityModeSelect.addEventListener("change", () => {
        velocityMode = velocityModeSelect.value;
        updateVelocityFields();
      });

      fixedVelocityRange.addEventListener("input", () => {
        fixedVelocity = Number(fixedVelocityRange.value);
      });

      pressureMinRange.addEventListener("input", () => {
        pressureMin = Number(pressureMinRange.value);
      });

      pressureMaxRange.addEventListener("input", () => {
        pressureMax = Number(pressureMaxRange.value);
      });

      touchSensitivityRange.addEventListener("input", () => {
        setTouchSensitivity(touchSensitivityRange.value);
      });

      touchCurveRange.addEventListener("input", () => {
        setTouchCurve(touchCurveRange.value);
      });

      touchAreaMaxRange.addEventListener("input", () => {
        setTouchAreaMax(touchAreaMaxRange.value);
      });

      markerModeSelect.addEventListener("change", () => {
        document.body.dataset.markerMode = markerModeSelect.value;
      });

      markerShapeSelect.addEventListener("change", () => {
        document.body.dataset.markerShape = markerShapeSelect.value;
      });

      markerOffsetRange.addEventListener("input", () => {
        setMarkerOffset(markerOffsetRange.value);
      });

      layoutModeSelect.addEventListener("change", () => {
        setLayoutMode(layoutModeSelect.value);
      });

      drumStyleSelect.addEventListener("change", () => {
        setDrumStyle(drumStyleSelect.value);
      });

      bendModeSelect.addEventListener("change", () => {
        setBendMode(bendModeSelect.value);
      });

      randomModeSelect.addEventListener("change", () => {
        randomMode = randomModeSelect.value;
        if (randomMode === "on") {
          applyRandomTheme();
        }
      });

      randomChaosRange.addEventListener("input", () => {
        setRandomChaos(randomChaosRange.value);
      });

      randomGenerateButton.addEventListener("click", () => {
        applyRandomTheme();
      });

      controlFillSelect.addEventListener("change", () => {
        document.body.dataset.controlFill = controlFillSelect.value;
      });

      padFillSelect.addEventListener("change", () => {
        document.body.dataset.padFill = padFillSelect.value;
      });

      markerColorInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--marker-color", markerColorInput.value);
      });

      themeSelect.addEventListener("change", () => {
        const theme = themes.find((entry) => entry.id === themeSelect.value);
        applyTheme(theme);
      });

      rowGapRange.addEventListener("input", () => {
        setRowGap(rowGapRange.value);
      });

      padTextSizeRange.addEventListener("input", () => {
        setPadTextSize(padTextSizeRange.value);
      });

      shapeSelect.addEventListener("change", () => {
        fretboard.dataset.shape = shapeSelect.value;
      });

      cornerRadiusRange.addEventListener("input", () => {
        document.documentElement.style.setProperty("--pad-radius", `${cornerRadiusRange.value}px`);
      });

      padFillInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--pad-fill", padFillInput.value);
      });

      padBorderInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--pad-border", padBorderInput.value);
      });

      padGlowInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--pad-glow", padGlowInput.value);
      });

      padActiveInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--pad-active-fill", padActiveInput.value);
      });

      padActiveGlowInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--pad-active-glow", padActiveGlowInput.value);
      });

      colorModeSelect.addEventListener("change", () => {
        colorMode = colorModeSelect.value;
        updateColorModeFields();
        applyRowColors();
      });

      gradientTopInput.addEventListener("input", applyRowColors);
      gradientBottomInput.addEventListener("input", applyRowColors);

      contentModeSelect.addEventListener("change", () => {
        contentMode = contentModeSelect.value;
        fretboard.dataset.contentMode = contentMode;
        drumkit.dataset.contentMode = contentMode;
        updateContentFields();
        updatePadEmoji();
      });

      emojiRandomSelect.addEventListener("change", () => {
        emojiRandomMode = emojiRandomSelect.value;
        updatePadEmoji();
      });

      emojiRestInput.addEventListener("input", () => {
        emojiRest = emojiRestInput.value;
        updatePadEmoji();
      });

      emojiActiveInput.addEventListener("input", () => {
        emojiActive = emojiActiveInput.value;
        updatePadEmoji();
      });

      function setPadImage(url) {
        const value = url ? `url("${url}")` : "none";
        document.documentElement.style.setProperty("--pad-image", value);
      }

      function setPadImageActive(url) {
        const value = url ? `url("${url}")` : "none";
        document.documentElement.style.setProperty("--pad-image-active", value);
      }

      imageRestInput.addEventListener("change", () => {
        const file = imageRestInput.files?.[0];
        if (!file) return;
        if (padImageUrl) URL.revokeObjectURL(padImageUrl);
        padImageUrl = URL.createObjectURL(file);
        setPadImage(padImageUrl);
        const reader = new FileReader();
        reader.onload = () => {
          padImageData = String(reader.result || "");
        };
        reader.readAsDataURL(file);
      });

      imageActiveInput.addEventListener("change", () => {
        const file = imageActiveInput.files?.[0];
        if (!file) return;
        if (padImageActiveUrl) URL.revokeObjectURL(padImageActiveUrl);
        padImageActiveUrl = URL.createObjectURL(file);
        setPadImageActive(padImageActiveUrl);
        const reader = new FileReader();
        reader.onload = () => {
          padImageActiveData = String(reader.result || "");
        };
        reader.readAsDataURL(file);
      });

      bgModeSelect.addEventListener("change", () => {
        document.body.dataset.bgMode = bgModeSelect.value;
        updateBackgroundFields();
      });

      bgColorInput.addEventListener("input", () => {
        document.documentElement.style.setProperty("--bg-color", bgColorInput.value);
      });

      bgImageInput.addEventListener("change", () => {
        const file = bgImageInput.files?.[0];
        if (!file) return;
        if (bgImageUrl) URL.revokeObjectURL(bgImageUrl);
        bgImageUrl = URL.createObjectURL(file);
        bgImage.src = bgImageUrl;
        bgModeSelect.value = "image";
        document.body.dataset.bgMode = "image";
        updateBackgroundFields();
        const reader = new FileReader();
        reader.onload = () => {
          bgImageData = String(reader.result || "");
        };
        reader.readAsDataURL(file);
      });

      bgVideoInput.addEventListener("change", () => {
        const file = bgVideoInput.files?.[0];
        if (!file) return;
        if (bgVideoUrl) URL.revokeObjectURL(bgVideoUrl);
        bgVideoUrl = URL.createObjectURL(file);
        bgVideo.src = bgVideoUrl;
        bgVideo.play().catch(() => {});
        bgModeSelect.value = "video";
        document.body.dataset.bgMode = "video";
        updateBackgroundFields();
        const reader = new FileReader();
        reader.onload = () => {
          bgVideoData = String(reader.result || "");
        };
        reader.readAsDataURL(file);
      });

      bgOpacityRange.addEventListener("input", () => {
        document.documentElement.style.setProperty("--bg-media-opacity", bgOpacityRange.value);
      });

      touchScaleSelect.addEventListener("change", () => {
        document.body.dataset.scale = touchScaleSelect.value;
      });

      touchGlowSelect.addEventListener("change", () => {
        document.body.dataset.glow = touchGlowSelect.value;
      });

      pulseGlowSelect.addEventListener("change", () => {
        document.body.dataset.pulse = pulseGlowSelect.value;
      });

      presetSaveButton.addEventListener("click", () => {
        const preset = collectSettings();
        savedPresets = savedPresets.filter((entry) => entry.id !== preset.id && entry.name !== preset.name);
        savedPresets.push(preset);
        savePresets();
        presetSelect.value = preset.id;
      });

      presetApplyButton.addEventListener("click", () => {
        const selected = savedPresets.find((entry) => entry.id === presetSelect.value);
        applySettings(selected);
      });

      presetDeleteButton.addEventListener("click", () => {
        if (!presetSelect.value) return;
        savedPresets = savedPresets.filter((entry) => entry.id !== presetSelect.value);
        savePresets();
      });

      function updateRowScale(gap) {
        const row = fretboard.querySelector(".string-row");
        if (!row) {
          document.documentElement.style.setProperty("--row-scale", "1");
          return;
        }
        const rowHeight = row.offsetHeight || row.getBoundingClientRect().height;
        if (!rowHeight) {
          document.documentElement.style.setProperty("--row-scale", "1");
          return;
        }
        const minScale = 0.7;
        const targetScale = gap < 0 ? (rowHeight + gap) / rowHeight : 1;
        const scale = Math.max(minScale, Math.min(1, targetScale));
        document.documentElement.style.setProperty("--row-scale", scale.toFixed(3));
      }

      function getMaxRowGap() {
        const row = fretboard.querySelector(".string-row");
        const pad = row?.querySelector(".pad");
        const padHeight = pad?.getBoundingClientRect().height || row?.getBoundingClientRect().height || 0;
        if (!padHeight) {
          return 80;
        }
        const toolbarHeight = toolbar?.getBoundingClientRect().height || 0;
        const markersHeight = (markersTop?.getBoundingClientRect().height || 0) + (markersBottom?.getBoundingClientRect().height || 0);
        const sustainHeight = sustainToggle?.getBoundingClientRect().height || 0;
        const appStyle = appRoot ? getComputedStyle(appRoot) : null;
        const paddingTop = appStyle ? parseFloat(appStyle.paddingTop) : 0;
        const paddingBottom = appStyle ? parseFloat(appStyle.paddingBottom) : 0;
        const areaStyle = fretboardArea ? getComputedStyle(fretboardArea) : null;
        const areaGap = areaStyle ? parseFloat(areaStyle.gap) : 0;
        const available =
          window.innerHeight - toolbarHeight - markersHeight - sustainHeight - paddingTop - paddingBottom - areaGap * 3;
        const maxGap = Math.floor((available - padHeight * STRINGS.length) / (STRINGS.length - 1));
        return clamp(maxGap, -40, 200);
      }

      function setRowGap(value) {
        const raw = Number(value);
        const row = fretboard.querySelector(".string-row");
        const maxGap = Math.max(0, getMaxRowGap());
        rowGapRange.max = String(maxGap);
        let clamped = clamp(raw, -40, maxGap);
        if (row) {
          const rowHeight = row.offsetHeight || row.getBoundingClientRect().height;
          if (rowHeight) {
            const minScale = 0.7;
            const minGap = rowHeight * (minScale - 1);
            if (clamped < minGap) {
              clamped = Math.ceil(minGap);
            }
          }
        }
        rowGapRange.value = String(clamped);
        document.documentElement.style.setProperty("--row-gap", `${clamped}px`);
        rowGapValue.textContent = `${clamped}px`;
        updateRowScale(clamped);
      }

      function setPadTextSize(value) {
        const clamped = clamp(Number(value), 16, 140);
        padTextSizeRange.value = String(clamped);
        document.documentElement.style.setProperty("--pad-text-size", `${clamped}px`);
        padTextSizeValue.textContent = `${clamped}px`;
      }

      function setTouchSensitivity(value) {
        const clamped = clamp(Number(value), 0.2, 3);
        touchSensitivity = clamped;
        touchSensitivityRange.value = String(clamped);
        touchSensitivityValue.textContent = `${Math.round(clamped * 100)}%`;
      }

      function setTouchCurve(value) {
        const clamped = clamp(Number(value), 0.2, 3);
        touchCurve = clamped;
        touchCurveRange.value = String(clamped);
        touchCurveValue.textContent = `${clamped.toFixed(2)}x`;
      }

      function setTouchAreaMax(value) {
        const clamped = clamp(Number(value), 200, 2000);
        touchAreaMax = clamped;
        touchAreaMaxRange.value = String(clamped);
        touchAreaMaxValue.textContent = String(clamped);
      }

      function updateVelocityFields() {
        const isPressure = velocityMode === "pressure";
        fixedVelocityField.classList.toggle("hidden", isPressure);
        pressureMinField.classList.toggle("hidden", !isPressure);
        pressureMaxField.classList.toggle("hidden", !isPressure);
        touchSensitivityField.classList.toggle("hidden", !isPressure);
        touchCurveField.classList.toggle("hidden", !isPressure);
        touchAreaMaxField.classList.toggle("hidden", !isPressure);
      }

      function updateContentFields() {
        const showEmoji = contentMode === "emoji";
        const showImage = contentMode === "image";
        padTextSizeField.classList.toggle("hidden", !showEmoji);
        emojiRestField.classList.toggle("hidden", !showEmoji);
        emojiActiveField.classList.toggle("hidden", !showEmoji);
        emojiRandomField.classList.toggle("hidden", !showEmoji);
        imageRestField.classList.toggle("hidden", !showImage);
        imageActiveField.classList.toggle("hidden", !showImage);
      }

      function updateBackgroundFields() {
        const mode = bgModeSelect.value;
        bgImageField.classList.toggle("hidden", mode !== "image");
        bgVideoField.classList.toggle("hidden", mode !== "video");
      }

      function updateColorModeFields() {
        const showGradient = colorMode === "gradient";
        gradientTopField.classList.toggle("hidden", !showGradient);
        gradientBottomField.classList.toggle("hidden", !showGradient);
      }

      function updatePressureStatus() {
        const pointerSupport = typeof PointerEvent !== "undefined";
        const supportsPressure = pointerSupport && "pressure" in PointerEvent.prototype;
        const supportsTouchForce = typeof Touch !== "undefined" && "force" in Touch.prototype;
        const supportsSize = pointerSupport && ("width" in PointerEvent.prototype || "height" in PointerEvent.prototype);
        if (supportsPressure || supportsTouchForce) {
          pressureStatus.textContent = "Pressure: supported";
        } else if (supportsSize) {
          pressureStatus.textContent = "Pressure: touch size fallback";
        } else {
          pressureStatus.textContent = "Pressure: not detected";
        }
      }

      fretboardArea.addEventListener("pointerdown", handlePointerDown);
      window.addEventListener("pointermove", handlePointerMove);
      window.addEventListener("pointerup", handlePointerUp);
      window.addEventListener("pointercancel", handlePointerUp);
      window.addEventListener("resize", () => {
        setRowGap(rowGapRange.value);
      });

      ["gesturestart", "gesturechange", "gestureend"].forEach((eventName) => {
        document.addEventListener(eventName, (event) => {
          event.preventDefault();
        });
      });

      document.addEventListener("contextmenu", (event) => {
        event.preventDefault();
      });

      document.addEventListener("selectstart", (event) => {
        if (!event.target.closest("input, textarea")) {
          event.preventDefault();
        }
      });

      buildMarkers();
      buildFretboard();
      buildDrumKit();
      populateThemes();
      themeSelect.value = themes[0]?.id || "";
      applyTheme(themes[0]);
      updateVelocityFields();
      updateContentFields();
      drumkit.dataset.contentMode = contentMode;
      updateBackgroundFields();
      updateColorModeFields();
      updatePressureStatus();
      setRowGap(rowGapRange.value);
      setPadTextSize(padTextSizeRange.value);
      setVibratoRate(vibratoRateRange.value);
      setVibratoDepth(vibratoDepthRange.value);
      setTouchSensitivity(touchSensitivityRange.value);
      setTouchCurve(touchCurveRange.value);
      setTouchAreaMax(touchAreaMaxRange.value);
      setMarkerOffset(markerOffsetRange.value);
      document.body.dataset.markerShape = markerShapeSelect.value;
      setDrumStyle(drumStyleSelect.value);
      setBendMode(bendModeSelect.value);
      setRandomChaos(randomChaosRange.value);
      setLayoutMode(layoutModeSelect.value, { skipBuild: true });
      if (randomMode === "on") {
        applyRandomTheme();
      }
      makeSettingsCollapsible();
      document.body.dataset.controlFill = controlFillSelect.value;
      document.body.dataset.padFill = padFillSelect.value;
      loadPresets();
      initMidi();
    </script>
  </body>
</html>
